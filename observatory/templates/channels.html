{% extends "base.html" %}

{% block title %}Channels - Wildcat Mesh Observatory{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <div class="card">
        <div class="card-header">ğŸ’¬ Channel Activity (24h)</div>
        <canvas id="channelChart" style="max-height: 400px;"></canvas>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“Š Quick Stats</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Total Messages</div>
                <div class="value">{{ stats.messages_24h }}</div>
                <div class="unit">last 24h</div>
            </div>
            <div class="stat-card">
                <div class="label">Active Channels</div>
                <div class="value">{{ channel_details|length }}</div>
                <div class="unit">channels</div>
            </div>
        </div>
    </div>
</div>

<!-- Channel Details Table -->
<div class="card">
    <div class="card-header">ğŸ“‹ Channel Details</div>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--primary);">
                <th style="text-align: left; padding: 0.75rem;">Channel</th>
                <th style="text-align: center; padding: 0.75rem;">Messages</th>
                <th style="text-align: center; padding: 0.75rem;">Unique Senders</th>
                <th style="text-align: center; padding: 0.75rem;">Avg SNR</th>
                <th style="text-align: left; padding: 0.75rem;">Last Activity</th>
            </tr>
        </thead>
        <tbody>
            {% for ch in channel_details %}
            <tr onclick="window.location.href='/channel/{{ ch.channel_index }}';"
                style="border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;"
                onmouseover="this.style.background='var(--bg-surface)'"
                onmouseout="this.style.background='transparent'"
                data-channel="{{ ch.channel_index }}">
                <td style="padding: 0.75rem;">
                    <strong class="channel-name-{{ ch.channel_index }}" style="color: var(--primary);">{{ ch.channel_index|channel_name }}</strong>
                    <br><small style="color: var(--text-secondary);">Channel {{ ch.channel_index }}</small>
                </td>
                <td style="text-align: center; padding: 0.75rem;">{{ ch.message_count }}</td>
                <td style="text-align: center; padding: 0.75rem;">{{ ch.unique_senders }}</td>
                <td style="text-align: center; padding: 0.75rem;">
                    <span style="color: {% if ch.avg_snr > 5 %}var(--success){% elif ch.avg_snr > 0 %}var(--warning){% else %}var(--danger){% endif %};">
                        {{ ch.avg_snr|round(1) if ch.avg_snr else 'N/A' }} dB
                    </span>
                </td>
                <td style="padding: 0.75rem; color: var(--text-secondary);">{{ ch.last_message|format_time }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    No channel activity in the last 24 hours
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Top Senders -->
<div class="card">
    <div class="card-header">ğŸ‘¥ Top Senders</div>

    <!-- Time Range Selector -->
    <div id="sendersTimeSelector" style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.5rem;">
        <button onclick="updateTopSenders(24)" class="time-btn active" data-hours="24"
           style="padding: 0.5rem 1rem; background: var(--primary); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">
            24 Hours
        </button>
        <button onclick="updateTopSenders(168)" class="time-btn" data-hours="168"
           style="padding: 0.5rem 1rem; background: var(--bg-dark); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">
            7 Days
        </button>
        <button onclick="updateTopSenders(720)" class="time-btn" data-hours="720"
           style="padding: 0.5rem 1rem; background: var(--bg-dark); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">
            30 Days
        </button>
    </div>

    {% if top_senders %}
    <canvas id="sendersChart" style="max-height: 300px;"></canvas>
    {% else %}
    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No message activity yet</p>
    {% endif %}
</div>

<!-- Hourly Heatmap -->
<div class="card">
    <div class="card-header">â° Activity Heatmap</div>

    <!-- Time Range Selector -->
    <div id="heatmapTimeSelector" style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.5rem;">
        <button onclick="updateHeatmap(24)" class="heatmap-time-btn active" data-hours="24"
           style="padding: 0.5rem 1rem; background: var(--primary); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">
            24 Hours
        </button>
        <button onclick="updateHeatmap(168)" class="heatmap-time-btn" data-hours="168"
           style="padding: 0.5rem 1rem; background: var(--bg-dark); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">
            7 Days
        </button>
        <button onclick="updateHeatmap(720)" class="heatmap-time-btn" data-hours="720"
           style="padding: 0.5rem 1rem; background: var(--bg-dark); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">
            30 Days
        </button>
    </div>

    <canvas id="heatmapChart" style="max-height: 400px;"></canvas>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Channel activity chart
const channelData = {{ channel_activity|tojson }};
const ctx1 = document.getElementById('channelChart').getContext('2d');

// Channel name mapping
const channelNames = {
    0: 'LongFast',
    1: 'Channel 1',
    2: 'Channel 2',
    3: 'Channel 3',
    4: 'Channel 4',
    5: 'Channel 5',
    6: 'Channel 6',
    7: 'Channel 7'
};

// Consistent channel color mapping
const channelColors = {
    0: '#2E7D32',  // Green for LongFast
    1: '#1565C0',  // Blue
    2: '#F57C00',  // Orange
    3: '#E91E63',  // Pink
    4: '#9C27B0',  // Purple
    5: '#00BCD4',  // Cyan
    6: '#FFB300',  // Amber
    7: '#D32F2F'   // Red
};

new Chart(ctx1, {
    type: 'doughnut',
    data: {
        labels: channelData.map(ch => channelNames[ch.channel_index] || 'Channel ' + ch.channel_index),
        datasets: [{
            data: channelData.map(ch => ch.count),
            backgroundColor: channelData.map(ch => channelColors[ch.channel_index] || '#666666'),
            borderWidth: 2,
            borderColor: '#121212'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right',
                labels: { color: '#FFFFFF' }
            }
        }
    }
});

// Top senders with REAL data
let topSenders = {{ top_senders|tojson }};
{% if top_senders %}
const ctx2 = document.getElementById('sendersChart').getContext('2d');
let sendersChart = new Chart(ctx2, {
    type: 'bar',
    data: {
        labels: topSenders.map(s => s.sender_short_name),
        datasets: [{
            label: 'Messages Sent',
            data: topSenders.map(s => s.message_count),
            backgroundColor: topSenders.map(s =>
                s.avg_snr > 5 ? '#2E7D32' : s.avg_snr > 0 ? '#F57C00' : '#C62828'
            ),
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
                const index = activeElements[0].index;
                const sender = topSenders[index];
                window.location.href = '/node/' + sender.sender_id;
            }
        },
        plugins: {
            legend: { labels: { color: '#FFFFFF' } },
            tooltip: {
                callbacks: {
                    afterLabel: function(context) {
                        const sender = topSenders[context.dataIndex];
                        return 'Avg SNR: ' + (sender.avg_snr ? sender.avg_snr.toFixed(1) : 'N/A') + ' dB';
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: { color: '#B0B0B0' },
                grid: { color: '#333333' }
            },
            y: {
                ticks: { color: '#B0B0B0' },
                grid: { color: '#333333' }
            }
        }
    }
});

// Add cursor pointer style when hovering over bars
document.getElementById('sendersChart').style.cursor = 'pointer';
{% endif %}

// Apply channel colors to channel details table
document.querySelectorAll('[data-channel]').forEach(row => {
    const channelIndex = parseInt(row.getAttribute('data-channel'));
    const color = channelColors[channelIndex] || '#666666';
    const nameEl = row.querySelector('.channel-name-' + channelIndex);
    if (nameEl) {
        nameEl.style.color = color;
    }
});

// Hourly heatmap
let hourlyData = {{ hourly_activity|tojson }};
const ctx3 = document.getElementById('heatmapChart').getContext('2d');
let heatmapChart;

// Process data into hourly buckets
const hours = Array.from({length: 24}, (_, i) => i);
const channels = [...new Set(hourlyData.map(d => d.channel_index))].sort();

const datasets = channels.map(ch => {
    const hourCounts = hours.map(h => {
        const found = hourlyData.find(d => d.hour === h && d.channel_index === ch);
        return found ? found.count : 0;
    });

    return {
        label: channelNames[ch] || 'Channel ' + ch,
        data: hourCounts,
        backgroundColor: channelColors[ch] || '#666666',
        borderColor: channelColors[ch] || '#666666',
        borderWidth: 1
    };
});

heatmapChart = new Chart(ctx3, {
    type: 'bar',
    data: {
        labels: hours.map(h => {
            if (h === 0) return '12AM';
            if (h === 12) return '12PM';
            if (h < 12) return h + 'AM';
            return (h - 12) + 'PM';
        }),
        datasets: datasets
    },
    options: {
        responsive: true,
        plugins: {
            legend: { labels: { color: '#FFFFFF' } },
            title: {
                display: true,
                text: 'Message Activity by Hour and Channel',
                color: '#FFFFFF'
            }
        },
        scales: {
            x: {
                stacked: true,
                ticks: { color: '#B0B0B0' },
                grid: { color: '#333333' }
            },
            y: {
                stacked: true,
                beginAtZero: true,
                title: { display: true, text: 'Messages', color: '#B0B0B0' },
                ticks: { color: '#B0B0B0' },
                grid: { color: '#333333' }
            }
        }
    }
});

// Update top senders chart with new time range
async function updateTopSenders(hours) {
    // Update button states
    document.querySelectorAll('#sendersTimeSelector .time-btn').forEach(btn => {
        if (btn.getAttribute('data-hours') == hours) {
            btn.style.background = 'var(--primary)';
            btn.classList.add('active');
        } else {
            btn.style.background = 'var(--bg-dark)';
            btn.classList.remove('active');
        }
    });

    // Fetch new data
    const response = await fetch(`/api/v1/top-senders?hours=${hours}`);
    topSenders = await response.json();

    // Update chart
    sendersChart.data.labels = topSenders.map(s => s.sender_short_name);
    sendersChart.data.datasets[0].data = topSenders.map(s => s.message_count);
    sendersChart.data.datasets[0].backgroundColor = topSenders.map(s =>
        s.avg_snr > 5 ? '#2E7D32' : s.avg_snr > 0 ? '#F57C00' : '#C62828'
    );
    sendersChart.update();
}

// Update heatmap with new time range
async function updateHeatmap(hours) {
    // Update button states
    document.querySelectorAll('#heatmapTimeSelector .heatmap-time-btn').forEach(btn => {
        if (btn.getAttribute('data-hours') == hours) {
            btn.style.background = 'var(--primary)';
            btn.classList.add('active');
        } else {
            btn.style.background = 'var(--bg-dark)';
            btn.classList.remove('active');
        }
    });

    // Fetch new data
    const response = await fetch(`/api/v1/hourly-activity?hours=${hours}`);
    hourlyData = await response.json();

    // Rebuild datasets
    const hours24 = Array.from({length: 24}, (_, i) => i);
    const channels = [...new Set(hourlyData.map(d => d.channel_index))].sort();

    const newDatasets = channels.map(ch => {
        const hourCounts = hours24.map(h => {
            const found = hourlyData.find(d => d.hour === h && d.channel_index === ch);
            return found ? found.count : 0;
        });

        return {
            label: channelNames[ch] || 'Channel ' + ch,
            data: hourCounts,
            backgroundColor: channelColors[ch] || '#666666',
            borderColor: channelColors[ch] || '#666666',
            borderWidth: 1
        };
    });

    // Update chart
    heatmapChart.data.datasets = newDatasets;
    heatmapChart.update();
}
</script>
{% endblock %}
